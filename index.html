<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç™½èŠ±æ²¹æ´»å‹•è¨ˆç®—ï¼ˆç¾é‡‘åƒ¹ï¼‰ï¼‹è¨‚å–®ç”Ÿæˆï¼‹å•†å“åœ–æª”é è¦½</title>
  <style>
    :root {
      --border: #ccc;
      --muted: #666;
      --gift: #0a7c2f;
      --card: #ffffff;
      --accent: #0b72ff;
      --warn: #b54708;
      --warnbg:#fff7e6;
    }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif; padding: 10px; background:#fff; }
    h2 { margin: 8px 0 14px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid var(--border); padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    input[type="number"], input[type="text"] { padding: 6px 8px; font-size: 1rem; }
    input[type="number"] { width: 90px; }
    .row { display:flex; flex-wrap: wrap; gap: 12px; align-items: center; margin: 8px 0; }
    .order-card {
      width: 880px; background: var(--card); color:#000; border: 1px solid var(--border);
      border-radius: 12px; padding: 18px; box-shadow: 0 6px 24px rgba(0,0,0,.06);
    }
    .order-head { display:flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .order-title { font-size: 20px; font-weight: 800; }
    .order-meta { font-size: 14px; color: #333; display:flex; gap: 16px; flex-wrap: wrap; }
    .order-table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px; table-layout: fixed; }
    .order-table th, .order-table td { border: 1px solid #ddd; padding: 6px 8px; text-align: right; word-wrap: break-word; }
    .order-table th:first-child, .order-table td:first-child { text-align: left; }
    .order-summary { margin-top: 10px; display: grid; grid-template-columns: 1fr auto; gap: 6px; font-size: 14px; }
    .order-summary .label { color: #333; }
    .order-summary .value { font-weight: 800; }
    .order-gift { margin-top: 8px; font-weight: 700; color: var(--gift); }
    .divider { height: 1px; background:#e8e8e8; margin: 8px 0; }
    button { padding: 10px 12px; font-size: 1rem; cursor: pointer; border-radius: 10px; border: 1px solid var(--border); background: white; }
    button.primary { background: var(--accent); color:#fff; border-color: var(--accent); }
    .sticky-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      background:#fff; border-top:1px solid var(--border);
      padding:10px; box-shadow:0 -2px 5px rgba(0,0,0,0.08); z-index:1000;
      display:flex; flex-direction:column; gap:8px;
    }
    .sticky-row { display:flex; justify-content:space-between; align-items:center; font-size: 14px; }
    .sticky-actions { display:flex; gap:8px; flex-wrap: wrap; }
    .gift-em { color: var(--gift); font-weight: 800; }
    .banner { display:none; background:var(--warnbg); color:var(--warn); border:1px solid #FACC15; padding:8px 10px; border-radius:8px; margin-bottom:8px; }
    .banner.show { display:block; }
    @media (max-width: 600px) {
      .order-card { width: 100%; padding: 12px; }
      body { padding-bottom: 190px; }
    }

    /* === åƒç…§ 25USTC.html çš„åœ–ç‰‡é è¦½å…ƒä»¶ === */
    #product-preview {
      position: fixed; pointer-events: none; z-index: 9999; display: none;
      background: #fff; border: 1px solid #ddd; border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.14); padding: 10px;
      max-width: 280px; max-height: 320px;
    }
    #product-preview img { width: 100%; height: auto; object-fit: contain; display:block; }
    #mobile-sheet {
      position: fixed; left: 0; right:0; bottom: -100%; z-index: 10000; 
      background: #fff; border-radius: 16px 16px 0 0; box-shadow: 0 -12px 30px rgba(0,0,0,.18);
      transition: bottom .25s ease; padding: 12px 12px 18px; max-height: 75vh; overflow: auto;
    }
    #mobile-sheet.open { bottom: 0; }
    #mobile-sheet img { width: 100%; height: auto; object-fit: contain; display:block; }
    #mobile-sheet .handle { width:48px; height:5px; border-radius: 5px; background:#ddd; margin: 6px auto 10px; }

    @media (max-width: 768px) {
      #product-preview { display: none !important; }
      #mobile-sheet {
        max-height: 80vh;
        padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
      }
      #mobile-sheet img {
        display: block;
        width: auto;
        height: auto;
        max-width: min(92vw, 520px);
        max-height: 60vh;
        object-fit: contain;
        margin: 6px auto 8px;
      }
    }

    /* åœ¨ç”¢å“åç¨±æ—æ”¾ä¸€å€‹ç¸®åœ–åœ–ç¤ºï¼ˆæœ‰åœ–æ‰é¡¯ç¤ºï¼‰ */
    .thumb-dot {
      display: none;
      margin-left: 6px;
      font-size: 12px;
      color: #888;
      cursor: zoom-in;
      user-select: none;
    }
    tr.has-image .thumb-dot { display: inline; }
    td.name-cell { text-align: left; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <h2>ç™½èŠ±æ²¹æ´»å‹•è¨ˆç®—ï¼ˆç¾é‡‘åƒ¹ï¼‰ï¼‹è¨‚å–®ç”Ÿæˆï¼‹å•†å“åœ–æª”é è¦½</h2>

  <div id="env-banner" class="banner"></div>

  <!-- åŸºæœ¬è¼¸å…¥ -->
  <div class="row">
    <label>å®¢æˆ¶åç¨±ï¼š<input type="text" id="customer" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜è—¥å±€"></label>
    <label>å‚™è¨»ï¼š<input type="text" id="note" placeholder="ä¾‹å¦‚ï¼šæ€¥ä»¶ï¼æ˜ŸæœŸå››åˆ°è²¨"></label>
    <label>ä¹‹å‰å·²å‡ºé‡‘é¡ï¼š<input type="number" id="previous-total" value="0" min="0" inputmode="numeric" pattern="[0-9]*"></label>
  </div>

  <table>
    <thead>
      <tr><th>å“å</th><th>ç¾é‡‘åƒ¹</th><th>æ•¸é‡</th><th>å°è¨ˆ</th></tr>
    </thead>
    <tbody id="product-table">
      <tr>
        <td class="name-cell">ç™½èŠ±æ²¹ #1 <span class="thumb-dot" title="æŸ¥çœ‹åœ–ç‰‡">ğŸ–¼ï¸</span></td>
        <td>240</td>
        <td><input type="number" min="0" value="0" inputmode="numeric" pattern="[0-9]*" data-price="240"></td>
        <td class="subtotal">0</td>
      </tr>
      <tr>
        <td class="name-cell">ç™½èŠ±æ²¹ #2 <span class="thumb-dot" title="æŸ¥çœ‹åœ–ç‰‡">ğŸ–¼ï¸</span></td>
        <td>154</td>
        <td><input type="number" min="0" value="0" inputmode="numeric" pattern="[0-9]*" data-price="154"></td>
        <td class="subtotal">0</td>
      </tr>
      <tr>
        <td class="name-cell">ç™½èŠ±æ²¹ #3 <span class="thumb-dot" title="æŸ¥çœ‹åœ–ç‰‡">ğŸ–¼ï¸</span></td>
        <td>89</td>
        <td><input type="number" min="0" value="0" inputmode="numeric" pattern="[0-9]*" data-price="89"></td>
        <td class="subtotal">0</td>
      </tr>
      <tr>
        <td class="name-cell">ç™½èŠ±æ²¹ XL <span class="thumb-dot" title="æŸ¥çœ‹åœ–ç‰‡">ğŸ–¼ï¸</span></td>
        <td>432</td>
        <td><input type="number" min="0" value="0" inputmode="numeric" pattern="[0-9]*" data-price="432"></td>
        <td class="subtotal">0</td>
      </tr>
    </tbody>
  </table>

  <!-- è¨‚å–®å¡ç‰‡ï¼ˆè¼¸å‡ºåœ–æª”ç”¨ï¼‰ -->
  <div id="order-card" class="order-card" style="margin-top:14px;">
    <div class="order-head">
      <div class="order-title">è¨‚å–®ç¢ºèªå–®</div>
      <div class="order-meta"><span id="meta-date"></span></div>
    </div>
    <div class="order-meta">
      <div>å®¢æˆ¶ï¼š<span id="meta-customer">â€”</span></div>
      <div>å‚™è¨»ï¼š<span id="meta-note">â€”</span></div>
    </div>
    <div class="divider"></div>
    <table class="order-table">
      <thead><tr><th>å“å</th><th>æ•¸é‡</th><th>å–®åƒ¹</th><th>å°è¨ˆ</th></tr></thead>
      <tbody id="order-items"><tr><td colspan="4" style="text-align:center;color:#666;">å°šæœªé¸è³¼ä»»ä½•å“é …</td></tr></tbody>
    </table>
    <div class="order-summary">
      <div class="label">æœ¬æ¬¡ç¸½è¨ˆï¼š</div><div class="value" id="sum-grand">0 å…ƒ</div>
      <div class="label">ä¹‹å‰å·²å‡ºï¼š</div><div class="value" id="sum-prev">0 å…ƒ</div>
      <div class="label">åŠ ç¸½é‡‘é¡ï¼š</div><div class="value" id="sum-final">0 å…ƒ</div>
    </div>
    <div class="order-gift" id="sum-gift">æ»¿é¡è´ˆå“ï¼šç„¡</div>
  </div>

  <!-- æ‰‹æ©Ÿåº•éƒ¨å›ºå®šè³‡è¨Šèˆ‡æ“ä½œ -->
  <div class="sticky-bar">
    <div class="sticky-row">ç¸½è¨ˆé‡‘é¡ï¼ˆå«å·²å‡ºï¼‰ï¼š<span id="grand-total">0</span> å…ƒ</div>
    <div class="sticky-row"><span class="gift-em" id="gift-info">æ»¿é¡è´ˆå“ï¼šç„¡</span></div>
    <div class="sticky-row" id="next-tier">è·é›¢ä¸‹ä¸€æ”¯é‚„å·®ï¼šâ€” å…ƒ</div>
    <div class="sticky-actions">
      <button id="clear-btn">é‡æ–°è¼¸å…¥</button>
      <button id="share-all-btn" class="primary">ç”Ÿæˆè¨‚å–®ä¸¦åˆ†äº«</button>
      <a id="share-line-text" target="_blank" rel="noopener"><button>ç”¨ LINE å‚³æ–‡å­—</button></a>
      <button id="open-tab-btn">é–‹æ–°åˆ†é çœ‹åœ–ï¼ˆAndroid å‚™æ´ï¼‰</button>
    </div>
  </div>

  <!-- ç”¢å“åœ–ç‰‡é è¦½ï¼ˆåƒç…§ 25USTC.htmlï¼‰ -->
  <div id="product-preview" aria-hidden="true">
    <img id="product-preview-img" alt="å•†å“é è¦½" loading="lazy" />
  </div>
  <div id="mobile-sheet" aria-hidden="true">
    <div class="handle"></div>
    <img id="mobile-sheet-img" alt="å•†å“é è¦½" loading="lazy" />
  </div>

<script>
  const inputs = document.querySelectorAll('input[type="number"][data-price]');
  const prevInput = document.getElementById('previous-total');
  const custInput = document.getElementById('customer');
  const noteInput = document.getElementById('note');

  const grandEl = document.getElementById('grand-total');
  const giftInfoEl = document.getElementById('gift-info');
  const nextTierEl = document.getElementById('next-tier');
  const clearBtn = document.getElementById('clear-btn');
  const shareAllBtn = document.getElementById('share-all-btn');
  const shareLineText = document.getElementById('share-line-text');
  const openTabBtn = document.getElementById('open-tab-btn');
  const envBanner = document.getElementById('env-banner');

  const orderItems = document.getElementById('order-items');
  const sumGrand = document.getElementById('sum-grand');
  const sumPrev = document.getElementById('sum-prev');
  const sumFinal = document.getElementById('sum-final');
  const sumGift = document.getElementById('sum-gift');
  const metaDate = document.getElementById('meta-date');
  const metaCustomer = document.getElementById('meta-customer');
  const metaNote = document.getElementById('meta-note');

  // === åœ–ç‰‡é è¦½ç›¸é—œ ===
  const preview = document.getElementById('product-preview');
  const previewImg = document.getElementById('product-preview-img');
  const sheet = document.getElementById('mobile-sheet');
  const sheetImg = document.getElementById('mobile-sheet-img');
  const PADDING = 16;
  const isDesktop = () => window.matchMedia('(min-width: 769px)').matches;

  const JSON_URLS = ['productImages.json', 'productImages_local.json']; // æ”¯æ´å…©ç¨®æª”å
  let imageMap = {};

  function normalizeName(s){
    return (s || '').replace(/\\u00A0/g, ' ').replace(/\\s+/g, ' ').trim();
  }

  async function loadMap(){
    for(const url of JSON_URLS){
      try{
        const r = await fetch(url, {cache:'no-cache'});
        if(r.ok){
          imageMap = await r.json();
          console.log('[é è¦½å°ç…§è¡¨è¼‰å…¥æˆåŠŸ]', url);
          return;
        }
      }catch(e){ /* try next */ }
    }
    console.warn('productImages å°ç…§è¡¨è¼‰å…¥å¤±æ•—ï¼Œåç¨±å°ç…§å°‡ç„¡æ³•é¡¯ç¤ºåœ–ç‰‡');
  }

  function getImgSrcFromName(name){
    const productName = normalizeName(name);
    let src = imageMap[productName];
    if(!src){
      const loose = productName.replace(/[Â®â„¢Â©]/g, '').trim();
      src = imageMap[loose];
    }
    return src || null;
  }

  function movePreview(e){
    const vw = innerWidth, vh = innerHeight;
    const w = preview.offsetWidth || 300, h = preview.offsetHeight || 200;
    let x = e.clientX + 18, y = e.clientY + 18;
    if (x + w + PADDING > vw) x = e.clientX - w - 18;
    if (y + h + PADDING > vh) y = e.clientY - h - 18;
    preview.style.left = Math.max(PADDING, x) + 'px';
    preview.style.top  = Math.max(PADDING, y) + 'px';
  }
  function showPreview(src){
    previewImg.src = src;
    preview.style.display = 'block';
  }
  function hidePreview(){
    preview.style.display = 'none';
    previewImg.removeAttribute('src');
  }
  function openSheet(src){
    sheetImg.src = src;
    sheet.classList.add('open');
    sheet.setAttribute('aria-hidden','false');
  }
  function closeSheet(){
    sheet.classList.remove('open');
    sheet.setAttribute('aria-hidden','true');
    sheetImg.removeAttribute('src');
  }
  sheet.addEventListener('click', (e)=>{
    if(e.target === sheet) closeSheet();
  });

  // åˆå§‹åŒ–è³‡æ–™åˆ—çš„ã€Œæœ‰åœ–ã€æ¨™ç¤º
  function markRowsHasImage(){
    document.querySelectorAll('#product-table tr').forEach(tr => {
      const nameCell = tr.querySelector('.name-cell');
      if(!nameCell) return;
      const name = nameCell.childNodes[0]?.textContent || nameCell.textContent;
      const src = getImgSrcFromName(name);
      if(src){
        tr.classList.add('has-image');
        nameCell.querySelector('.thumb-dot')?.setAttribute('data-src', src);
      } else {
        tr.classList.remove('has-image');
      }
    });
  }

  function bindPreviewEvents(){
    // æ¡Œæ©Ÿï¼šæ»‘éæ•´åˆ—é¡¯ç¤ºé è¦½
    document.addEventListener('mouseover', (e) => {
      if (!isDesktop()) return;
      const tr = e.target.closest('#product-table tr.has-image');
      if (!tr) return;
      const dot = tr.querySelector('.thumb-dot');
      const src = dot?.getAttribute('data-src');
      if (!src) return;
      showPreview(src);
      movePreview(e);
    });
    document.addEventListener('mousemove', (e) => {
      if (!isDesktop()) return;
      if (preview.style.display === 'block') movePreview(e);
    });
    document.addEventListener('mouseout', (e) => {
      if (!isDesktop()) return;
      if (e.target.closest('#product-table tr')) hidePreview();
    });

    // æ‰‹æ©Ÿï¼šé»æ“Šç¸®åœ–åœ–ç¤ºæˆ–åç¨±æ‰“é–‹ bottom sheet
    document.addEventListener('click', (e) => {
      if (isDesktop()) return;
      const dot = e.target.closest('.thumb-dot');
      const nameCell = e.target.closest('.name-cell');
      let src = null;
      if (dot) {
        src = dot.getAttribute('data-src');
      } else if (nameCell) {
        const name = nameCell.childNodes[0]?.textContent || nameCell.textContent;
        src = getImgSrcFromName(name);
      }
      if (src) openSheet(src);
    });
  }

  // === è¨‚å–®/é‡‘é¡è¨ˆç®— ===
  const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
  const ua = navigator.userAgent || '';
  const inApp = /Line\/|FBAN|FBAV|Instagram|FB_IAB/i.test(ua);
  const isAndroid = /Android/i.test(ua);

  function showEnvHints(){
    let msgs = [];
    if(!isSecure) msgs.push('âš ï¸ å»ºè­°ç”¨ HTTPS ç¶²å€é–‹å•Ÿï¼ˆæˆ– localhostï¼‰ï¼ŒAndroid æ‰èƒ½ä½¿ç”¨ç³»çµ±åˆ†äº«ã€‚');
    if(inApp) msgs.push('âš ï¸ ä½ ç›®å‰åœ¨ App å…§å»ºç€è¦½å™¨ï¼ˆå¦‚ LINEï¼FBï¼‰ï¼Œè«‹é»å³ä¸Šè§’ã€Œåœ¨ Chrome é–‹å•Ÿã€å†åˆ†äº«ã€‚');
    if(msgs.length){ envBanner.innerText = msgs.join(' '); envBanner.classList.add('show'); }
  }
  showEnvHints();

  // è´ˆå“è¦å‰‡ï¼šæ¯ 21,000 è¨ˆ 4 æ”¯ï¼›é¤˜æ•¸å†ä»¥æ¯ 7,000 è¨ˆ 1 æ”¯
  function calcGifts(total){
    const bigBlocks=Math.floor(total/21000);
    const remainder=total%21000;
    const smallBlocks=Math.floor(remainder/7000);
    return bigBlocks*4+smallBlocks;
  }
  function currentDateStr(){
    const d=new Date(); const p=n=>n.toString().padStart(2,'0');
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
  }
  function buildTextMessage(data) {
    const lines = [];
    lines.push(`ã€è¨‚å–®ç¢ºèªå–®ã€‘`);
    lines.push(`æ—¥æœŸï¼š${currentDateStr()}`);
    lines.push(`å®¢æˆ¶ï¼š${custInput.value || 'â€”'}`);
    lines.push(`å‚™è¨»ï¼š${noteInput.value || 'â€”'}`);
    lines.push('â€”â€”â€”');
    if (data.items.length === 0) lines.push('ï¼ˆå°šæœªé¸è³¼ä»»ä½•å“é …ï¼‰');
    data.items.forEach(it => lines.push(`${it.name} Ã— ${it.qty}ï¼ˆ$${it.price}ï¼‰ï¼ $${it.sub}`));
    lines.push('â€”â€”â€”');
    lines.push(`æœ¬æ¬¡ç¸½è¨ˆï¼š$${data.grand}`);
    lines.push(`ä¹‹å‰å·²å‡ºï¼š$${data.prev}`);
    lines.push(`åŠ ç¸½é‡‘é¡ï¼š$${data.final}`);
    lines.push(data.gifts > 0 ? `æ»¿é¡è´ˆï¼šç™½èŠ±æ²¹ #1 Ã— ${data.gifts} æ”¯` : 'æ»¿é¡è´ˆï¼šç„¡');
    return lines.join('\n');
  }
  function collectOrderData() {
    const rows = Array.from(document.querySelectorAll('#product-table tr'));
    const items = [];
    rows.forEach(tr => {
      const name = tr.querySelector('.name-cell').childNodes[0]?.textContent.trim() || tr.querySelector('.name-cell').textContent.trim();
      const price = parseFloat(tr.querySelector('td:nth-child(2)').textContent.trim());
      const qty = parseInt(tr.querySelector('input').value || '0', 10);
      if (qty > 0) items.push({ name, price, qty, sub: qty * price });
    });
    const grand = items.reduce((s, it) => s + it.sub, 0);
    const prev = parseInt(prevInput.value || '0', 10) || 0;
    const final = grand + prev;
    const gifts = calcGifts(final);
    return { items, grand, prev, final, gifts };
  }
  function updateTotals(){
    const data = collectOrderData();
    // æ›´æ–°æ¸…å–®
    orderItems.innerHTML = '';
    if (data.items.length === 0) {
      orderItems.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#666;">å°šæœªé¸è³¼ä»»ä½•å“é …</td></tr>';
    } else {
      data.items.forEach(it => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="text-align:left">${it.name}</td><td>${it.qty}</td><td>${it.price}</td><td>${it.sub}</td>`;
        orderItems.appendChild(tr);
      });
    }
    // æ›´æ–°è¡¨æ ¼å°è¨ˆ
    document.querySelectorAll('#product-table tr').forEach((tr,i)=>{
      const input = tr.querySelector('input');
      const price = parseFloat(input.dataset.price);
      const qty = parseInt(input.value || '0',10) || 0;
      tr.querySelector('.subtotal').textContent = price * qty;
    });
    // æ›´æ–°é‡‘é¡/è´ˆå“/åº•éƒ¨é¡¯ç¤º
    sumGrand.textContent = data.grand + ' å…ƒ';
    sumPrev.textContent = data.prev + ' å…ƒ';
    sumFinal.textContent = data.final + ' å…ƒ';
    grandEl.textContent = data.final;
    const giftText = data.gifts>0 ? `æ»¿é¡è´ˆå“ï¼šç™½èŠ±æ²¹ #1 Ã— ${data.gifts} æ”¯` : 'æ»¿é¡è´ˆå“ï¼šç„¡';
    giftInfoEl.textContent = giftText;
    sumGift.textContent = giftText;
    nextTierEl.textContent = `è·é›¢ä¸‹ä¸€æ”¯é‚„å·®ï¼š${Math.max(0,(Math.floor(data.final/7000)+1)*7000 - data.final)} å…ƒ`;
    metaDate.textContent = currentDateStr();
    metaCustomer.textContent = custInput.value || 'â€”';
    metaNote.textContent = noteInput.value || 'â€”';
    // æ›´æ–° LINE æ–‡å­—åˆ†äº«é€£çµ
    shareLineText.href = 'https://line.me/R/msg/text/?' + encodeURIComponent(buildTextMessage(data));
  }
  // è‡ªå‹•æ¸…é›¶ï¼šfocus æ¸… 0ã€blur ç©ºç™½è£œ 0
  function attachAutoClearZero(input){
    input.addEventListener('focus', ()=>{ if(input.value === '0') input.value = ''; });
    input.addEventListener('blur', ()=>{ if(input.value === '') input.value = '0'; });
    input.addEventListener('input', updateTotals);
  }
  document.querySelectorAll('input[type="number"][data-price]').forEach(attachAutoClearZero);
  attachAutoClearZero(prevInput);
  custInput.addEventListener('input', updateTotals);
  noteInput.addEventListener('input', updateTotals);

  async function renderCardToBlob(){
    await new Promise(r=>setTimeout(r,40));
    const canvas = await html2canvas(document.getElementById('order-card'), {scale:2, backgroundColor:'#fff', useCORS:true});
    return await new Promise(res=>canvas.toBlob(res, 'image/png', 0.95));
  }

  async function shareAll(){
    updateTotals();
    const blob = await renderCardToBlob();
    const file = new File([blob], 'order.png', {type:'image/png'});
    const data = collectOrderData();
    const shareData = { title:'è¨‚å–®ç¢ºèªå–®', text: buildTextMessage(data), files:[file] };
    // 1) å…ˆå˜—è©¦ Web Share with filesï¼ˆAndroid Chrome 89+ & HTTPSï¼‰
    if ((location.protocol === 'https:' || location.hostname === 'localhost') && navigator.canShare && navigator.canShare({ files:[file] })) {
      try { await navigator.share(shareData); return; }
      catch (e) { /* ä½¿ç”¨è€…å–æ¶ˆæˆ–å¤±æ•— */ }
    }
    // 2) å‚™æ´ Aï¼šä¸‹è¼‰åˆ°ã€Œä¸‹è¼‰ã€è³‡æ–™å¤¾
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'order.png';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    // 3) å‚™æ´ Bï¼ˆAndroid å‹å–„ï¼‰ï¼šé–‹æ–°åˆ†é é¡¯ç¤ºåœ–ç‰‡ï¼Œé•·æŒ‰ã€Œå„²å­˜åœ–ç‰‡ã€å¯é€²ç›¸ç°¿
    if (/Android/i.test(navigator.userAgent || '')) {
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
      alert('å·²ç‚ºä½ ä¸‹è¼‰åœ–æª”ï¼Œè‹¥æœªå‡ºç¾åœ¨ç›¸ç°¿ï¼Œè«‹åˆ‡åˆ°æ–°åˆ†é é•·æŒ‰åœ–ç‰‡ã€Œå„²å­˜åœ–ç‰‡ã€ï¼Œå†åˆ° LINE ä»¥åœ–ç‰‡åˆ†äº«ã€‚');
    } else {
      alert('å·²ç‚ºä½ ä¸‹è¼‰åœ–æª”ï¼Œå¯åˆ° LINE/Email æ‰‹å‹•é™„åŠ åœ–ç‰‡åˆ†äº«ã€‚');
    }
  }

  async function openImageTab(){
    updateTotals();
    const blob = await renderCardToBlob();
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank'); // æ–¹ä¾¿ Android é•·æŒ‰å„²å­˜åˆ°ç›¸ç°¿
  }

  clearBtn.addEventListener('click', ()=>{
    document.querySelectorAll('input[type="number"][data-price]').forEach(i=>i.value='0');
    prevInput.value='0'; custInput.value=''; noteInput.value='';
    updateTotals();
  });
  shareAllBtn.addEventListener('click', shareAll);
  openTabBtn.addEventListener('click', openImageTab);

  // å•Ÿå‹•ï¼šè¼‰å…¥åœ–ç‰‡å°ç…§è¡¨ â†’ æ¨™ç¤ºæœ‰åœ–åˆ— â†’ ç¶å®šäº‹ä»¶
  (async function init(){
    await loadMap();
    markRowsHasImage();
    bindPreviewEvents();
    updateTotals();
  })();
</script>
</body>
</html>
